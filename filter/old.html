<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
</head>
<body>
<canvas width="400" height="400"></canvas>
<script>
    (function () {
        var canvas1 = document.querySelector( "canvas" );
        var gc1 = canvas1.getContext( "2d" );


        var img = new Image();
        img.src = "../img/6.jpg";
        var canvas = document.createElement( "canvas" );
        var w = h = 400;
        canvas.height = canvas.width = w;
        document.body.appendChild( canvas );
        var gc = canvas.getContext( "2d" );
        img.onload = function () {
            gc1.drawImage( img, 0, 0, w, h );
            gc.drawImage( img, 0, 0, w, h );
            var imgData = gc.getImageData( 0, 0, w, h );
            var s = (new Date()).getTime();
            imgData.data = filter( imgData.data, w, h );
            console.log( (new Date()).getTime() - s );
            gc.putImageData( imgData, 0, 0 );
        };
        var r, g, b;
        var nr, ng, nb;
        var index;

        function filter( data, w, h ) {
            for ( var y = 0; y < h; y++ ) {
                for ( var x = 0; x < w; x++ ) {
                    index = (y * w + x) * 4;
                    r = data[index];
                    g = data[index + 1];
                    b = data[index + 2];
                    nr = (r * 0.393 + g * 0.769 + b * 0.189) << 0;
                    ng = (r * 0.349 + g * 0.686 + b * 0.168) << 0;
                    nb = (r * 0.272 + g * 0.534 + b * 0.131) << 0;
                    data[index] = blendColor( noise(), nr, r );
                    data[index + 1] = blendColor( noise(), ng, g );
                    data[index + 2] = blendColor( noise(), nb, b );
                }
            }
            return data;
        }

        function blendColor( noise, dest, src ) {
            return (noise * dest + (1 - noise) * src) << 0;
        }

        function noise() {
            return Math.random() / 2 + 0.5;
        }

    })()
</script>
</body>
</html>