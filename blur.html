<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<canvas width="400" height="400"></canvas>
<script>
    (function () {

        var canvas = document.querySelector( "canvas" );
        var ctx = canvas.getContext( "2d" );
        var w = 400, h = 400;
        var img = new Image();
        img.src = "../img/1.jpg";
        img.onload = function () {
            var s = (new Date()).getTime();
            ctx.drawImage( img, 0, 0, w, h );
            var data = ctx.getImageData( 0, 0, w, h );
            ctx.clearRect( 0, 0, w, h );
            var g = (new Date()).getTime();
            data.data = filter( data.data, w, h );
            console.log( (new Date()).getTime() - g );
            ctx.putImageData( data, 0, 0 );
            console.log( (new Date()).getTime() - s );
        };

        var rvalue = 0, gvalue = 0, avalue = 0;

        var mat = [
            [-2, -2], [-1, -2], [0, -2], [1, -2], [2, -2],
            [-2, -1], [-1, -1], [0, -1], [1, -1], [2, -1],
            [-2, 0], [-1, 0], [1, 0], [2, 0],
            [-2, 1], [-1, 1], [0, 1], [1, 1], [2, 1],
            [-2, 2], [-1, 2], [0, 2], [1, 2], [2, 2]
        ];
        var count = 0;

        function filter( imageData, w, h ) {
            for ( var x = 0; x < w; x++ ) {
                for ( var y = 0; y < h; y++ ) {
                    for ( var n = 0; n < 24; n++ ) {
                        if ( x + mat[n][0] >= 0 && x + mat[n][0] <= w && y + mat[n][1] >= 0 && y + mat[n][1] <= h ) {
                            count += 1;
                            rvalue += imageData[((y + mat[n][1]) * w + x + mat[n][0]) * 4];
                            gvalue += imageData[((y + mat[n][1]) * w + x + mat[n][0]) * 4 + 1];
                            avalue += imageData[((y + mat[n][1]) * w + x + mat[n][0]) * 4 + 2];
                        }
                    }
                    rvalue /= count;
                    gvalue /= count;
                    avalue /= count;
                    count = 0;
                    imageData[(y * w + x) * 4] = rvalue;
                    imageData[(y * w + x) * 4 + 1] = gvalue;
                    imageData[(y * w + x) * 4 + 2] = avalue;
                    rvalue = gvalue = avalue = 0;
                }
            }
            return imageData;
        }

    })();
</script>
</body>
</html>