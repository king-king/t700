<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<canvas width="400" height="400"></canvas>
<script src="js/blur.js"></script>
<script>
    (function () {

        var canvas = document.querySelector( "canvas" );
        var ctx = canvas.getContext( "2d" );
        var w = 400, h = 400;
        var img = new Image();
        img.src = "img/1.jpg";
        img.onload = function () {
            var s = (new Date()).getTime();
            ctx.drawImage( img, 0, 0, w, h );
            var data = ctx.getImageData( 0, 0, w, h );
            ctx.clearRect( 0, 0, w, h );
            var g = (new Date()).getTime();
            data.data = filter( data.data, w, h );
            console.log( (new Date()).getTime() - g );
            ctx.putImageData( data, 0, 0 );
            console.log( (new Date()).getTime() - s );
        };

//        img.onload = function () {
//            var s = (new Date()).getTime();
//            document.body.appendChild( blur( img, 10, null, null ) );
//            console.log( (new Date()).getTime() - s );
//        };

        var rvalue = 0, gvalue = 0, avalue = 0;

        var mat5 = [
            [-2, -2], [-1, -2], [0, -2], [1, -2], [2, -2],
            [-2, -1], [-1, -1], [0, -1], [1, -1], [2, -1],
            [-2, 0], [-1, 0], [1, 0], [2, 0],
            [-2, 1], [-1, 1], [0, 1], [1, 1], [2, 1],
            [-2, 2], [-1, 2], [0, 2], [1, 2], [2, 2]
        ];
        var count = 0;

        var ox, oy, os, zb;

        function filter( imageData, w, h ) {
            for ( var x = 0; x < w; x++ ) {
                for ( var y = 0; y < h; y++ ) {
                    for ( var n = 0; n < 24; n++ ) {
                        ox = mat5[n][0];
                        oy = mat5[n][1];
                        if ( x + ox >= 0 && x + ox <= w && y + oy >= 0 && y + oy <= h ) {
                            count += 1;
                            os = ((y + mat5[n][1]) * w + x + mat5[n][0]) << 2;
                            rvalue += imageData[os];
                            gvalue += imageData[os + 1];
                            avalue += imageData[os + 2];
                        }
                    }
                    rvalue /= count;
                    gvalue /= count;
                    avalue /= count;
                    count = 0;
                    zb = (y * w + x) * 4;
                    imageData[zb] = rvalue;
                    imageData[zb + 1] = gvalue;
                    imageData[zb + 2] = avalue;
                    rvalue = gvalue = avalue = 0;
                }
            }
            return imageData;
        }

    })();
</script>
</body>
</html>