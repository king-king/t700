<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <meta name="mobileoptimized" content="0"/>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="screen-orientation" content="portrait">
    <meta name="browsermode" content="application">
    <title></title>
    <link href="../lib/style/basic.css" rel="stylesheet">
    <style>
        .banner {
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
        }

        .banner .item {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
<div class="loading-page"></div>
<div class="body">
    <div class="page">1
        <div class="banner"></div>
    </div>
    <div class="page">2</div>
    <div class="page">3</div>
    <div class="page">4</div>
</div>

<script src="../lib/util/basic.js"></script>
<script src="../lib/util/build.js"></script>
<script>
    (function () {

        function makeBanner( banner, data ) {
            var content = util.createElement( "div", {classList : "content"}, banner );
            var curindex = 0;
            var width = content.offsetWidth;
            var items = {
                all : [],
                length : 0,
                fetch : function ( index ) {
                    index = (index + items.all.length) % items.all.length;
                    return items.all[index];
                },
                push : function ( item ) {
                    items.length++;
                    items.all.push( item );
                    var index = items.all.length - 1;
                    item.next = function () {
                        return items.fetch( index + 1 );
                    };
                    item.pre = function () {
                        return items.fetch( index - 1 );
                    }
                }
            };
            util.loopArray( data, function ( src ) {
                var item = util.createElement( "div", {
                    classList : "item",
                    css : {
                        background : "url(" + src + ")",
                        "background-size" : "cover"
                    }
                } );
                items.push( item );
            } );
            function initPosition( item ) {
                item.pre().transform( -width, 0, 0 );
                item.transform( 0, 0, 0 );
                item.next().transform( width, 0, 0 );
                content.appendChild( item.pre() );
                content.appendChild( item );
                content.appendChild( item.next() );
            }

            initPosition( items.fetch( curindex ) );

            function removeItems( item ) {
                item.remove();
                item.pre().remove();
                item.next().remove();
            }

            var handler = {};

            banner.onDrag( {
                x : true,
                onMove : function ( arg ) {
                    util.loopArray( [items.fetch( curindex ), items.fetch( curindex ).pre(), items.fetch( curindex ).next()], function ( item ) {
                        item.transform( item.wx += arg.dx, 0, 0 );
                    } );
                },
                onEnd : function ( arg ) {
                    var count = 0;
                    util.loopArray( [items.fetch( curindex ).pre(), items.fetch( curindex ), items.fetch( curindex ).next()], function ( item, i ) {
                        util.transition( item, {
                            "-webkit-transform" : "translate3d(" + (arg.dx < 0 ? -width * (i - 2) : width * i) + "px,0,0)",
                            "-webkit-transition" : "0.2s linear"
                        }, function () {
                            count += 1;
                            if ( count == 2 ) {
                                removeItems( items.fetch( curindex ) );
                                curindex = (curindex + (arg.dx < 0 ? 1 : -1) + items.length) % items.length;
                                handler.onCut && handler.onCut( curindex );
                                initPosition( items.fetch( curindex ) );
                                banner.isTouching = false;
                            }
                        } )
                    } );
                }
            } );

        }

        system.onopen = function () {
            makeBanner( Pages[0].querySelector( ".banner" ), [
                "img/1.jpg",
                "img/2.jpg",
                "img/3.jpg",
                "img/4.jpg",
                "img/5.jpg"
            ] );
        };


    })();
</script>
</body>
</html>